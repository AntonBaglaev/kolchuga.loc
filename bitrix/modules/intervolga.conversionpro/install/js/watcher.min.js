!function(){"use strict";function e(e,t){if(this._counterId=parseInt(e),0>=this._counterId)throw new Error("Wrong Yandex.Metrika counter ID");this._debug="function"==typeof t?t:function(){},this._timer=null}function t(e,t){if(this._counterId=e,"string"!=typeof this._counterId||0===this._counterId.length)throw new Error("Wrong Universal Analytics view ID");this._debug="function"==typeof t?t:function(){},this._timer=null}function n(n,r,o,i){switch(this._metrikaReady=!1,this._analyticsReady=!1,n){case"yg":break;case"oy":this._analyticsReady=!0;break;case"og":this._metrikaReady=!0;break;case"dr":this._analyticsReady=!0,this._metrikaReady=!0;break;default:throw new Error("Unknown module ready type")}this._metrikaWatcher=!1,this._metrikaReady||(this._metrikaWatcher=new e(r,i)),this._analyticsWatcher=!1,this._analyticsReady||(this._analyticsWatcher=new t(o,i)),this._debug="function"==typeof i?i:function(){}}function r(e,t){if(this._containerName=e,"string"!=typeof this._containerName||0===this._containerName.length)throw new Error("Wrong data layer name");this._inProgress=!1,this._queuePath="/bitrix/components/intervolga/conversionpro.queue/ajax.php",this._debug="function"==typeof t?t:function(){}}function o(e,t){var n=e||navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,r=t||navigator.userAgent,o=["Windows NT 6.1","Windows NT 6.2","Windows NT 6.3"],i=r.match(/Firefox\/(\d+)/),a=/MSIE|Trident/i,u=a.test(r),s=r.match(/Windows.+?(?=;)/g);return(!u||"function"==typeof Array.prototype.indexOf)&&(n=i&&parseInt(i[1],10)<32?"Unspecified":u&&s&&o.indexOf(s.toString())!==-1?"Unspecified":{0:"Disabled",1:"Enabled"}[n]||"Unspecified","Enabled"===n)}"indexOf"in Array.prototype||(Array.prototype.indexOf=function(e,t){void 0===t&&(t=0),t<0&&(t+=this.length),t<0&&(t=0);for(var n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1});var i={_prefix:"",prefix:function(e){return"string"==typeof e&&(i._prefix=e),i._prefix+"_"},get:function(e){e=i.prefix()+e;var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):null},set:function(e,t,n){e=i.prefix()+e,t=encodeURIComponent(t),n=n||{};var r=n.expires;if("number"==typeof r&&r){var o=new Date;o.setTime(o.getTime()+1e3*r),r=n.expires=o}r&&r.toUTCString&&(n.expires=r.toUTCString()),n.path||(n.path="/");var a=e+"="+t;for(var u in n)if(n.hasOwnProperty(u)){a+="; "+u;var s=n[u];s!==!0&&(a+="="+s)}document.cookie=a},del:function(e){i.set(e,"",{expires:-1})}};e.prototype.counterName=function(){return"yaCounter"+this._counterId},e.prototype.isActive=function(){return null!==this._timer},e.prototype.counterReady=function(){var e=null;if(window.Ya&&window.Ya.Metrika&&window.Ya.Metrika.counters&&(e=window.Ya.Metrika.counters()),window.Ya&&window.Ya.Metrika2&&window.Ya.Metrika2.counters&&(e=window.Ya.Metrika2.counters()),null===e)return!1;for(var t=0;t<e.length;t++)if(e[t].id===this._counterId)return!0;return!1},e.prototype.start=function(e){if(this.isActive())return!1;if(e="function"==typeof e?e:function(){},this.counterReady())return this._debug("Yandex.Metrika <-> counter "+this._counterId+" loaded"),e(),!1;this._debug("Yandex.Metrika --> started waiting for counter "+this._counterId);var t=0,n=this;return this._timer=setInterval(function(){if(!n.counterReady()){if(t+=1,30===t){n._debug("Yandex.Metrika --- counter "+n._counterId+" not loaded after 30 ticks");var r="/bitrix/components/intervolga/conversionpro.queue/ajax.php";BX.ajax({url:r,method:"POST",dataType:"html",data:BX.ajax.prepareData({NOTREADY:"YM"})})}return void n._debug("Yandex.Metrika --- counter "+n._counterId+" not loaded")}n._debug("Yandex.Metrika --- counter "+n._counterId+" loaded"),n.stop(),e()},1e3),!0},e.prototype.stop=function(){return!!this.isActive()&&(clearInterval(this._timer),this._debug("Yandex.Metrika <-- finished waiting for counter "+this._counterId),!0)},t.prototype.isActive=function(){return null!==this._timer},t.prototype.counterReady=function(){if(!window.ga||!window.ga.getAll)return!1;for(var e=ga.getAll(),t=null,n=0;n<e.length;n++)e[n].get("trackingId")===this._counterId&&(t=e[n]);return null!==t},t.prototype.start=function(e){if(this.isActive())return!1;if(e="function"==typeof e?e:function(){},this.counterReady())return this._debug("Universal Analytics <-> counter "+this._counterId+" loaded"),e(),!1;this._debug("Universal Analytics --> started waiting for counter "+this._counterId);var t=0,n=this;return this._timer=setInterval(function(){if(!n.counterReady()){if(t+=1,30===t){n._debug("Universal Analytics --- counter "+n._counterId+" not loaded after 30 ticks");var r="/bitrix/components/intervolga/conversionpro.queue/ajax.php";BX.ajax({url:r,method:"POST",dataType:"html",data:BX.ajax.prepareData({NOTREADY:"UA"})})}return void n._debug("Universal Analytics --- counter "+n._counterId+" not loaded")}n._debug("Universal Analytics --- counter "+n._counterId+" loaded"),n.stop(),e()},1e3),!0},t.prototype.stop=function(){return!!this.isActive()&&(clearInterval(this._timer),this._debug("Universal Analytics <-- finished waiting for counter "+this._counterId),!0)},n.prototype.isReady=function(){return this._metrikaReady&&this._analyticsReady},n.prototype.checkReady=function(e){this.isReady()?(this._debug("Module <-- ready to work"),e()):this._debug("Module --- not ready to work")},n.prototype.start=function(e){this._debug("Module --> started waiting for ready"),e="function"==typeof e?e:function(){};var t=this;return BX.ready(function(){t.checkReady(e),t._metrikaWatcher&&t._metrikaWatcher.start(function(){t._metrikaReady=!0,t.checkReady(e)}),t._analyticsWatcher&&t._analyticsWatcher.start(function(){t._analyticsReady=!0,t.checkReady(e)})}),!0},r.prototype.check=function(){return this._debug("Queue --> check"),this._inProgress?void this._debug("Queue <-- blocked"):(this._inProgress=!0,"Y"!==i.get("IEC_CHK")?(this._debug("Queue <-- no events"),void(this._inProgress=!1)):(this._debug("Queue --- has events"),void this.load()))},r.prototype.load=function(){this._debug("Queue --- loading from server");var e=this;BX.ajax.loadJSON(this._queuePath,function(t){if(e._debug("Queue --- loaded from server"),i.del("IEC_CHK"),"[object Array]"!==Object.prototype.toString.call(t))return e._debug("Queue <-- wrong answer format"),void(e._inProgress=!1);if(0===t.length)return e._debug("Queue <-- empty answer"),void(e._inProgress=!1);for(var n=[],r=0;r<t.length;r++){var o=t[r];e._debug(o);try{window[e._containerName].push(o.DATA),n.push(o.ID)}catch(u){e._debug("Queue --- error while sending "+u.message)}}if(n.length===t.length)a("Queue --- all events were sent");else{if(0===n.length)return a("Queue <-- no events were sent"),void(c._inProgress=!1);a("Queue --- some events were not sent")}setTimeout(function(){e.remove(n)},2e3)},function(){e._debug("Queue <-- error during loading from server"),e._inProgress=!1})},r.prototype.remove=function(e){this._debug("Queue --- remove processed events #: "+e.join(", "));var t=this;BX.ajax({url:t._queuePath,method:"POST",dataType:"html",data:BX.ajax.prepareData({PROCESSED:e.join(",")}),onsuccess:function(){t._debug("Queue <-- processed events were removed"),t._inProgress=!1,t.check()},onfailure:function(){t._debug("Queue <-- error remove processed events"),t._inProgress=!1}})},r.prototype.ajaxDaemon=function(){var e=this;BX.addCustomEvent("onAjaxSuccess",function(t,n){n&&n.url&&n.url.indexOf(e._queuePath)===-1?(e._debug("Queue --- found success BX Ajax-request "+n.url),e.check()):n&&!n.url&&(e._debug("Queue --- found success BX Ajax-request (no url)"),e.check())}),window.jQuery&&jQuery(document).ajaxSuccess(function(t,n,r){r&&r.url&&r.url.indexOf(e._queuePath)===-1?(e._debug("Queue --- found success jQuery Ajax-request "+r.url),e.check()):r&&!r.url&&(e._debug("Queue --- found success jQuery Ajax-request (no url)"),e.check())})};var a=function(e){window.location.href.indexOf("conversionpro_debug=Y")>=0&&i.set("IEC_DEBUG","Y"),window.location.href.indexOf("conversionpro_debug=N")>=0&&i.del("IEC_DEBUG"),"Y"===i.get("IEC_DEBUG")&&console.debug(e)};if(!window.BX||!window.BX.ajax)throw new Error("BX.ajax not loaded");if(!window.conversionpro_config||"object"!=typeof window.conversionpro_config)throw new Error("Configuration for module intervolga.conversionpro not found on page");var u=window.conversionpro_config;if(!u.container_name||!window[u.container_name])throw new Error("Data layer not found on page");if(i.prefix("BITRIX_SM"),BX.message&&null!==BX.message("COOKIE_PREFIX")&&i.prefix(BX.message("COOKIE_PREFIX")),"Y"===i.get("IEC_ADM"))return void a("You are administrator. Module intervolga.conversionpro will not send any data.");if(o()){window.conversionpro_config.ready_when="dr",a("DoNotTrack acquired, module will process events on document.ready");var s="/bitrix/components/intervolga/conversionpro.queue/ajax.php";BX.ajax({url:s,method:"POST",dataType:"html",data:BX.ajax.prepareData({DNT:"Y"})})}var c=new r(u.container_name,a),d=new n(u.ready_when,u.metrika_id,u.analytics_id,a);d.start(function(){BX.onCustomEvent("onConversionProReady",[u,a]),c.check(),c.ajaxDaemon()})}();
//# sourceMappingURL=watcher.min.js.map